const express = require('express');
const nodemailer = require('nodemailer');
const cors = require('cors');
const bodyParser = require('body-parser');
const path = require('path');

const app = express();

// Middleware
app.use(cors());
app.use(bodyParser.json({ limit: '50mb', charset: 'utf-8' }));
app.use(bodyParser.urlencoded({ limit: '50mb', extended: true, charset: 'utf-8' }));

// ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ±Ù…ÙŠØ² Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
app.use((req, res, next) => {
    res.setHeader('Content-Type', 'application/json; charset=utf-8');
    next();
});

// ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©
app.use(express.static(path.join(__dirname)));

// ØªÙ‚Ø¯ÙŠÙ… Ù…ÙƒØªØ¨Ø© XLSX Ù…Ù† node_modules
app.get('/xlsx.min.js', (req, res) => {
    res.sendFile(path.join(__dirname, 'node_modules/xlsx/dist/xlsx.full.min.js'));
});

// Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html'));
});

app.get('/test', (req, res) => {
    res.sendFile(path.join(__dirname, 'test.html'));
});

// Ù…Ø³Ø§Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
app.post('/send-email', async (req, res) => {
    try {
        const { to, subject, message, from, appPassword } = req.body;
         console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨:', req.body);
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!to || !subject || !message || !from || !appPassword) {
            return res.status(400).json({
                success: false,
                error: 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§Ù…Ù„Ø©'
            });
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(to) || !emailRegex.test(from)) {
            return res.status(400).json({
                success: false,
                error: 'Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­'
            });
        }

        // Ø¥Ù†Ø´Ø§Ø¡ transporter Ù„Ù€ Gmail Ù…Ø¹ Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
        const transporter = nodemailer.createTransport({
            service: 'gmail',
            auth: {
                user: from,
                pass: appPassword
            },
            pool: {
                maxConnections: 1,
                maxMessages: 5
            }
        });

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø¹ Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©
        const mailOptions = {
            from: from,
            to: to,
            subject: subject,
            html: `<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="font-family: Arial, sans-serif; direction: rtl; text-align: right;">
    ${message}
</body>
</html>`,
            headers: {
                'Content-Type': 'text/html; charset=utf-8',
                'X-Mailer': 'DigitHub Emails'
            }
        };

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯
        transporter.sendMail(mailOptions, (error, info) => {
            if (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', error);
                return res.status(500).json({
                    success: false,
                    error: error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯'
                });
            }

            console.log('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', info.response);
            res.json({
                success: true,
                message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­',
                info: info.messageId
            });
        });

    } catch (error) {
        console.error('Ø®Ø·Ø£ Ø¹Ø§Ù…:', error);
        res.status(500).json({
            success: false,
            error: error.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨',
            details: error.toString()
        });
    }
});

// Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
app.use((err, req, res, next) => {
    console.error('Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:', err);
    res.status(500).json({
        success: false,
        error: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹',
        details: err.message
    });
});

// Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø§Ø¯Ù…
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
    console.log(`ğŸš€ Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰: http://localhost:${PORT}`);
    console.log('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ http://localhost:' + PORT);
});
